
name: Update Store Mirror

on:
  workflow_dispatch:
  # Trigger immediately after an app is approved and added
  workflow_run:
    workflows: ["Process App Submission"]
    types:
      - completed
  release:
    types: [published]
  schedule:
    - cron: '0 */6 * * *' # Run every 6 hours to sync data

permissions:
  contents: write

jobs:
  update-mirror:
    # Only run if the triggering workflow succeeded (or if run manually/scheduled)
    if: ${{ !github.event.workflow_run || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install requests msgpack

      - name: Generate Mirror Data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python .github/scripts/mirror_generator.py

      - name: Deploy to Ghost Branch (Data)
        run: |
          git config --global user.name "Orion Bot"
          git config --global user.email "bot@orion.store"
          
          echo "ðŸ“¦ Stashing new mirror data..."
          # 1. Stash generated data OUTSIDE the git workspace
          mkdir -p ../temp_ghost
          cp mirror.json ../temp_ghost/ 2>/dev/null || echo "âš ï¸ mirror.json missing"
          cp updates.bin ../temp_ghost/ 2>/dev/null || echo "âš ï¸ updates.bin missing"
          cp -r mirrors ../temp_ghost/ 2>/dev/null || echo "âš ï¸ mirrors/ missing"
          
          echo "ðŸ›¡ï¸ Checking for existing Sentinel data..."
          # 2. Fetch existing data branch to preserve 'sentinel' folder
          # We use || true to prevent failure if the branch doesn't exist yet
          git fetch origin data:data || echo "Data branch not found on remote."
          
          # Check if data branch exists locally now
          if git show-ref --verify --quiet refs/heads/data; then
            git checkout data
            if [ -d "sentinel" ]; then
               echo "âœ… Preserving Sentinel directory..."
               cp -r sentinel ../temp_ghost/
            else
               echo "â„¹ï¸ No Sentinel directory found to preserve."
            fi
          fi
          
          # 3. Create fresh orphan state (Ghost Protocol)
          # We use a temp branch name to ensure clean slate
          git checkout --orphan ghost_data
          
          # 4. Nuke everything
          git rm -rf .
          git clean -fdx
          
          # 5. Restore All Data
          echo "â™»ï¸ Restoring data..."
          cp ../temp_ghost/mirror.json . 2>/dev/null || :
          cp ../temp_ghost/updates.bin . 2>/dev/null || :
          cp -r ../temp_ghost/mirrors . 2>/dev/null || :
          
          if [ -d "../temp_ghost/sentinel" ]; then
             cp -r ../temp_ghost/sentinel .
          fi
          
          rm -rf ../temp_ghost
          
          # 6. Commit & Force Push
          git add .
          git commit -m "Update Data (Mirror + Sentinel) [skip ci]"
          
          # Rename to data and push
          git branch -M data
          git push origin data --force
