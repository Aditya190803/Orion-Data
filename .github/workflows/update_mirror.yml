
name: Update Store Mirror

on:
  workflow_dispatch:
  # Trigger immediately after an app is approved and added
  workflow_run:
    workflows: ["Process App Submission"]
    types:
      - completed
  release:
    types: [published]
  schedule:
    - cron: '0 */6 * * *' # Run every 6 hours to sync data

permissions:
  contents: write

jobs:
  update-mirror:
    # Only run if the triggering workflow succeeded (or if run manually/scheduled)
    if: ${{ !github.event.workflow_run || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install requests msgpack

      - name: Generate Mirror Data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python .github/scripts/mirror_generator.py

      - name: Deploy to Ghost Branch (Data)
        run: |
          git config --global user.name "Orion Bot"
          git config --global user.email "bot@orion.store"
          
          echo "ðŸ“¦ Stashing data..."
          # 1. Stash generated data OUTSIDE the git workspace (../) to survive 'git clean'
          mkdir -p ../temp_ghost
          cp mirror.json ../temp_ghost/ 2>/dev/null || echo "âš ï¸ mirror.json missing"
          cp updates.bin ../temp_ghost/ 2>/dev/null || echo "âš ï¸ updates.bin missing"
          cp -r mirrors ../temp_ghost/ 2>/dev/null || echo "âš ï¸ mirrors/ missing"
          
          # 2. Switch to Orphan Branch
          # This disconnects from main history
          git checkout --orphan data
          
          # 3. Nuke everything (Clean State)
          git rm -rf .
          git clean -fdx
          
          echo "â™»ï¸ Restoring data..."
          # 4. Restore Data from outside stash
          cp ../temp_ghost/mirror.json . 2>/dev/null || :
          cp ../temp_ghost/updates.bin . 2>/dev/null || :
          cp -r ../temp_ghost/mirrors . 2>/dev/null || :
          rm -rf ../temp_ghost
          
          # 5. Commit & Force Push
          git add mirror.json updates.bin mirrors/
          
          # Only commit if there are changes
          git commit -m "Update Mirror Data (Ghost Protocol) [skip ci]"
          git push origin data --force
