
name: Update Orion Sentinel Intelligence

on:
  schedule:
    - cron: '0 0 * * *' # Daily
  workflow_dispatch:

permissions:
  contents: write

jobs:
  compile-intelligence:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install requests

      - name: Compile Threat Database
        env:
          # In production, use secrets for paid feeds if any
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p .github/scripts
          # Ensure threat_compiler.py exists before running
          if [ -f ".github/scripts/threat_compiler.py" ]; then
            python .github/scripts/threat_compiler.py
          else
            echo "Compiler script not found, creating dummy for demo..."
            echo 'import json; print("Dummy Compiler"); open("sentinel.json", "w").write("[]")' > dummy.py
            python dummy.py
          fi

      - name: Deploy to Ghost Branch (Data)
        run: |
          git config --global user.name "Orion Sentinel"
          git config --global user.email "bot@orion.store"
          
          # Stash the binary
          mkdir -p ../temp_sentinel
          cp sentinel.json ../temp_sentinel/ 2>/dev/null || echo "No Sentinel JSON"
          
          # Switch to data branch
          git fetch origin data:data || git checkout --orphan data
          git checkout data
          
          # Copy back
          cp ../temp_sentinel/sentinel.json . 2>/dev/null || :
          
          git add sentinel.json
          git commit -m "Update Threat Intelligence [skip ci]" || echo "No changes"
          git push origin data
